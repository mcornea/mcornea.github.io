<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Cisco 881G - Configuring Dynamic Failover On a Backup 3G Cellular Link</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">        
        <meta name="description" content="remote-lab.net learn by doing Linux and networking tutorials https://remote-lab.net
">
        <link rel="canonical" 
        href="https://remote-lab.net//dynamic-routing-with-failover-on-backup-3g-link">
        
        <!-- Harmony styles -->
        <link rel="stylesheet" type="text/css" href="https://remote-lab.net/assets/css/main.css">

        <!-- Modernizr js -->
        <script async src="https://remote-lab.net/assets/js/modernizr.js"></script>    

        <!-- IE Fixes -->
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->        
    </head>
    <body class="theme-base-01">
        <header class="main-header">
            <div class="wc-container">
                <h1><a href="https://remote-lab.net/">remote-lab.net</a></h1>
                <h2>learn by doing</h2>
                <ul>
	<li>
		<a href="https://remote-lab.net">Home</a><span>/</span>
	</li>
	<li>
		<a href="https://remote-lab.net//about">About</a><span>/</span>
	</li>
	<li>
		<a href="https://remote-lab.net//blog">Blog</a><span>/</span>
	</li>
	<li>
		<a href="https://compute.remote-lab.net" target="_blank">Compute</a><span>/</span>
	</li>
	<li>
		<a href="https://remote-lab.net//docs">Docs</a><span>/</span>
	</li>
</ul>
                
            </div>
        </header>
        <div class="page-content wc-container">
	
	<div class="post">
		<h1>Cisco 881G - Configuring Dynamic Failover On a Backup 3G Cellular Link</h1>
		<p class="post-meta">
			
      <span class="categories">
      routing and ios
      </span> |
	    
	    <span class="post-date">
    	Jan 9, 2012 
	    </span>
		</p>		
		<div class="post">
			<p>My latest lab toy is a Cisco 881G which integrates a cellular 3G interface used a secondary data link. In the following article I will present the existing scenario and what needs to be acomplished.
<a href="https://remote-lab.net/assets/static/3GBackup.png"><img class="aligncenter size-large wp-image-104" title="3GBackup" src="https://remote-lab.net/assets/static/3GBackup.png" alt="" width="550" height="401" /></a></p>

<hr />

<p>What’s the scenario? We have a small LAN using private IP addresses which need to be translated on both the external links. The primary link is an Ethernet drop so it’s very unlikely to change its state to down so that the router can detect the link failure and make the changes in its RIB. In order to detect a failure on the primary link we have to implement a mechanism which takes an external point as reference and measures different parameters.  For instance in my scenario we will send ICMP packets to an external IP address - 8.8.8.8, the Google public DNS server, and measure the RTT. As long as the RTT value is within certain limits the default route will be set on the primary link. If it exceeds that value then the default route set on the primary link will be dropped out of the routing table and a secondary default route - the one from the backup link, which has a higher administrative distance will take its place.</p>

<p>We have to make sure that the ICMP packets sent for checking the RTT will be sent only from the primary link. Otherwise when the backup link becomes active it checks the RTT and gets a proper value and it install the primary default route thus resulting in a loop of default routes.</p>

<p>Enough with the words, now let’s get to the config lines:</p>

<p>First of all, let’s configure the cellular interface so that it can connect to the 3G network:</p>

<h2 id="configuring-the-cellular-interface">Configuring the cellular interface</h2>
<p>We must ensure that the SIM card is not locked with a PIN code - Cellular 0 is the interface:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router#cellular <span class="m">0</span> gsm sim unlock <span class="nv">$PIN</span></code></pre></div>

<p>We need to create a gsm profile with the settings associated with your data account:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router#cellular <span class="m">0</span> gsm profile create <span class="m">1</span> internet ipv4 pap cisco cisco
<span class="s2">&quot;1&quot;</span> - Profile number
<span class="s2">&quot;internet&quot;</span> - Access Point Name
<span class="s2">&quot;ipv4&quot;</span> - Packet Data Protocol
<span class="s2">&quot;pap&quot;</span> - Authentication <span class="nb">type</span>
<span class="s2">&quot;cisco&quot;</span> - Username
<span class="s2">&quot;cisco&quot;</span> - Password</code></pre></div>

<p>Next we need to create a chat script which sends commands to the 3G modem to connect to the remote system. The chat script is called CellScript with a timeout value of 30 seconds. Please note that the script may be different depending on the carrier.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#chat-script CellScript &quot;&quot; &quot;ATDT*98*1#&quot; TIMEOUT 30 &quot;CONNECT&quot;</span>
<span class="s2">&quot;1&quot;</span> - represents the number of the gsm profile created above</code></pre></div>

<p>Associate the created chat script to the 3G modem line, for the 881G is line 3:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#line 3</span>
Router<span class="o">(</span>config-line<span class="o">)</span><span class="c">#script dialer CellScript</span></code></pre></div>

<p>Next we should create a Dialer interface:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#interface Dialer2</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ip address negotiated</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ip virtual-reassembly in</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#encapsulation ppp</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer pool 2</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer idle-timeout 0</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer string CellScript</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer persistent</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer-group 2</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ppp authentication pap callin</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ppp pap password 7 045F1E0B0238</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ppp ipcp dns request</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#no cdp enable</span></code></pre></div>

<p>The next step required is to configure the Cellular interface</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#interface Cellular0</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ip address negotiated</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ip virtual-reassembly in</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#encapsulation ppp</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer in-band</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer pool-member 2</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer idle-timeout 0</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#dialer-group 2</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#async mode interactive</span></code></pre></div>

<p>Create a dialer list which allows IP packets for the interfaces in dialer group 2:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#dialer-list 2 protocol ip permit</span></code></pre></div>

<p>Add a default route and you should have a working 3G data link:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#ip route 0.0.0.0 0.0.0.0 Dialer2</span></code></pre></div>

<h2 id="configuring-nat-with-multiple-pools">Configuring NAT with multiple pools</h2>
<p>OK, now that we have set the 3G backup data link I assume that you know how to configure the primary Ethernet link so we can pass to the next section: how to get Network Address Translation work on both interfaces.
First we need to set an access list which identifies our private addresses - in my case: 10.0.0.0/28</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#access-list 10 permit 10.0.0.0 0.0.0.15</span></code></pre></div>

<p>Next we’ll create route maps which identify both the private ip addresses by the ACL created above and the external interface:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#route-map PRIMARY permit 1 ; 1 is a sequence number in the route map function</span>
Router<span class="o">(</span>config-route-map<span class="o">)</span> <span class="c">#match ip address 10 ; matches all IP traffic identified by ACL 10</span>
Router<span class="o">(</span>config-route-map<span class="o">)</span><span class="c">#match interface FastEthernet4</span>
Router<span class="o">(</span>config<span class="o">)</span><span class="c">#route-map BACKUP permit 1</span>
Router<span class="o">(</span>config-route-map<span class="o">)</span> <span class="c">#match ip address 10</span>
Router<span class="o">(</span>config-route-map<span class="o">)</span><span class="c">#match interface Dialer2</span></code></pre></div>

<p>Last we have to set the NAT direction on the interfaces we are interested in:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#interface Vlan 55</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ip nat inside</span>
Router<span class="o">(</span>config<span class="o">)</span><span class="c">#interface FastEthernet4</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ip nat outside</span>
Router<span class="o">(</span>config<span class="o">)</span><span class="c">#interface Dialer2</span>
Router<span class="o">(</span>config-if<span class="o">)</span><span class="c">#ip nat outside</span></code></pre></div>

<p>Now that we have the route maps set we need the create the NAT translation rules. On both of the interfaces I will set NAT overload as I have a single IP address assigned by the ISP:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c"># ip nat inside source route-map PRIMARY interface FastEthernet4 overload</span>
Router<span class="o">(</span>config<span class="o">)</span><span class="c"># ip nat inside source route-map BACKUP interface Dialer2 overload</span></code></pre></div>

<h2 id="configuring-dynamic-failover-with-cisco-ip-slas">Configuring dynamic failover with Cisco IP SLAs</h2>
<p>The address translation is complete too. In the next section we will implement the dynamic failover mechanism using Cisco IP Service Level Agreements ( SLAs ). The Cisco IOS IP SLA is a powerful tool which can help improve your networks services. It allows you to monitor traffic parameters like round-trip delay, one-way delay, one-way jitter, packet loss, TCP connection time, DNS lookup time and many others. Let’s get to the config line and show how we should implement the SLAs.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#ip sla 1</span>
Router<span class="o">(</span>config<span class="o">)</span><span class="c">#icmp-echo 8.8.8.8 interface FastEthernet 4 ; pings 8.8.8.8 with the source address of Fa4</span>
Router<span class="o">(</span>config<span class="o">)</span><span class="c">#timeout 150 ; the amount of time in milliseconds the IP SLA operation waits a response from its request packet</span>
Router<span class="o">(</span>config<span class="o">)</span><span class="c">#frequency  2 ; the amount of time in seconds at which the IP SLA operation performs</span>
Router<span class="o">(</span>config<span class="o">)</span><span class="c">#ip sla schedule 1 life forever start-time now</span></code></pre></div>

<p>To review the above config lines: The routers pings 8.8.8.8 with  ICMP REQUEST packets having the source address of Fa4 and if an ICMP REPLY packet isn’t received within 150ms the IP SLA operation is considered to have failed. This process is repeated once every 2 seconds.
We set this process to start now and occur forever.</p>

<p>Now what happens if the IP SLA operation fails? In the following lines we’ll tell the router what to do in that case:</p>

<p>We need to create a track object to monitor the status of the IP SLA we have created:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#track 1 ip sla 1 reachability</span></code></pre></div>

<p>The track object informs the static route if a state change of the IP SLA occurs.</p>

<p>Next we will associate the primary default route with the tracker.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#ip route 0.0.0.0 0.0.0.0 FastEthernet4 track 1</span></code></pre></div>

<p>and assign a higher administrative distance to the secondary default route:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">Router<span class="o">(</span>config<span class="o">)</span><span class="c">#ip route 0.0.0.0 0.0.0.0 Dialer2 10</span></code></pre></div>

<p>And that should be all. You should now have a dynamic failover route without having to enable dynamic routing protocols.
Pretty cool :)</p>

		</div>
	</div>


	
	<div class="related">
		<h4>Related Posts</h2>
		<ul class="posts">
		    
		    <li>
			  <span>05 Apr 2015 &raquo;</span>
			  <a href="https://remote-lab.net//getting-started-with-docker">Getting started with Docker and the wonders of Open Source</a>
		    </li>
		    
		    <li>
			  <span>24 Feb 2015 &raquo;</span>
			  <a href="https://remote-lab.net//opsf-on-ios-with-ansible">OSPF lab provisioning on IOS with Ansible</a>
		    </li>
		    
		    <li>
			  <span>12 Oct 2014 &raquo;</span>
			  <a href="https://remote-lab.net//sdn-intro-basic-with-ovs-and-pox">SDN Intro: Basic L2 connectivity by using OVS and POX</a>
		    </li>
		    
		</ul>
	</div>
	

	<div class="post-footer">
		<div class="column-1">
			
				<a href="https://remote-lab.net//virtualbox-web-interface"><< Older</a>
			
		</div>
		<div class="column-2"><a href="https://remote-lab.net// ">Home</a></div>
		<div class="column-3">
			
				<a href="https://remote-lab.net//linux-server-cluster-using-heartbeat">Newer >></a>
			
		</div>
	</div>
</div>
 

        <footer class="main-footer">
            <div class="wc-container">
                <div class="column one">
                    <h6>Few more links</h6>
<ul class="menu">
    <li><a href="https://remote-lab.net">Home</a></li>
    <li><a href="https://remote-lab.net//about">About</a></li>
    <li><a href="https://remote-lab.net//blogroll">Blogroll</a></li>
    <li><a href="https://remote-lab.net//docs">Docs</a></li>
</ul>		
                    
                </div>
                <div class="column two">
                    <h6>Follow me</h6>

<ul class="social-media">


    
    <li>
        <a title="remoteur on Twitter" 
            href="https://twitter.com/remoteur" 
            class="twitter wc-img-replace" target="_blank">Twitter</a>
    </li>   
    

    
    <li>
        <a title="remoteur on Github" 
            href="https://github.com/remoteur" 
            class="github wc-img-replace" target="_blank">Github</a>
    </li>
     

    
    <li>
        <a title="marius.catalin.31542 on Facebook" 
            href="https://facebook.com/marius.catalin.31542" 
            class="facebook wc-img-replace" target="_blank">Facebook</a>
    </li>
    

    

    

    

</ul>
                </div>
            </div>
            <p class="wc-container disclaimer">
                
Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>
            </p>
        </footer>
        <script type="text/javascript">
          /* To avoid render blocking css */
          var cb = function() {
            var l = document.createElement('link'); l.rel = 'stylesheet';
            l.href = 'https://fonts.googleapis.com/css?family=Ubuntu+Mono&subset=latin';
            var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h);
          };
          var raf = requestAnimationFrame || mozRequestAnimationFrame ||
              webkitRequestAnimationFrame || msRequestAnimationFrame;
          if (raf) raf(cb);
          else window.addEventListener('load', cb);
        </script>
        <!-- jQuery -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- When no internet load JQuery from local -->
        <script>window.jQuery || document.write('<script src="https://remote-lab.net//assets/js/jquery.min.js"><\/script>')</script>
        <!-- Site js -->
        <script src="https://remote-lab.net/assets/js/all.js"></script>
        <!-- Google analytics  -->
        
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-xxxx-x']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

    </body>        
</html>
