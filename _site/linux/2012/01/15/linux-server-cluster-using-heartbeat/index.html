<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Linux Servers Cluster using HeartBeat</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">        
        <meta name="description" content="Harmony is a free responsive jekyll theme by Gayan Virajith and Maheshika Lakmali. Sourced on Github -  https://github.com/gayanvirajith/harmony
">
        <link rel="canonical" 
        href="http://remoteur.github.io//linux/2012/01/15/linux-server-cluster-using-heartbeat/">
        
        <!-- Harmony styles -->
        <link rel="stylesheet" type="text/css" href="http://remoteur.github.io/assets/css/main.css">

        <!-- Modernizr js -->
        <script async src="http://remoteur.github.io/assets/js/modernizr.js"></script>    

        <!-- IE Fixes -->
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->        
    </head>
    <body class="theme-base-01">
        <header class="main-header">
            <div class="wc-container">
                <h1><a href="http://remoteur.github.io/">remote-lab.net</a></h1>
                <h2>learn by doing</h2>
                <ul>
	<li>
		<a href="http://remoteur.github.io">Home</a><span>/</span>
	</li>
	<li>
		<a href="http://remoteur.github.io//about">About</a><span>/</span>
	</li>
	<li>
		<a href="http://remoteur.github.io//blog">Blog</a><span>/</span>
	</li>
	<li>
		<a href="https://compute.remote-lab.net" target="_blank">Compute</a><span>/</span>
	</li>
</ul>
                
            </div>
        </header>
        <div class="page-content wc-container">
	
	<div class="post">
		<h1>Linux Servers Cluster using HeartBeat</h1>
		<p class="post-meta">
			
      <span class="categories">
      linux
      </span> |
	    
	    <span class="post-date">
    	Jan 15, 2012 
	    </span>
		</p>		
		<div class="post">
			<p>Hello guys,</p>
<p>Today I've been working to set up a High Availability cluster made up of 2 virtual instances of CentOS Servers using Heartbeat. The cluster will be using one of the servers as primary and the second one as backup. The basic idea behing Heartbeat is that the backup server will be continuously pinging the primary server (using broadcast, multicast or unicast packets). In the eventuality that the active server goes down the backup server sets up a floating IP address, sends a gratious ARP message informing the others hosts on the local network segment that the mac-address corresponding to the floating IP has changed. The floating IP address is an IP address shared by the active and standby servers but it's assigned just to one of them at a time.</p>
<p>Heartbeat setup is pretty straight forward, I'll describe in the following lines how you can install it on a CentOS system.</p>
<p>1. Download the latest epel-release rpm from</p>
<pre>[root@server1 ~]# wget http://download.fedora.redhat.com/pub/epel/6/i386/epel-release-6-5.noarch.rpm
[root@server1 ~]# rpm -uvh epel-release-6-5.noarch.rpm</pre>
<p>2. Install Heartbeat packages:</p>
<pre>[root@server1 ~]# yum install heartbeat</pre>
<p>3. The Heartbeat config files are authkeys, ha.cf and haresources. We have to move thos into /etc/ha.d/ directory and edit them according to our setup.</p>
<pre>[root@server1 ~]# cp /usr/share/doc/heartbeat-3.0.4/authkeys /etc/ha.d/
[root@server1 ~]# cp /usr/share/doc/heartbeat-3.0.4/ha.cf /etc/ha.d/
[root@server1 ~]# cp /usr/share/doc/heartbeat-3.0.4/haresources /etc/ha.d/</pre>
<p>3.1 Edit authkeys with sha1 as authentication method:</p>
<pre>[root@server1 ~]# vim /etc/ha.d/authkeys</pre>
<pre>auth 2
2 sha1 pass</pre>
<p>Change the permission for /etc/ha.d/authkeys to "600":</p>
<pre> [root@server1 ~]# chmod 600 /etc/ha.d/authkeys</pre>
<p>3.2. Now let's edit the ha.cf configuration file:</p>
<pre>[root@server1 ~]# vim /etc/ha.d/ha.cf</pre>
<pre>logfile /var/log/ha-log #File to write log messages to
logfacility local0 #Facility to use for syslog()/logger
keepalive 1 #how long between heartbeats?
deadtime 5 #how long-to-declare-host-dead?
bcast eth0 #What interfaces to broadcast heartbeats over?
udpport 694 #What UDP port to use for bcast/ucast communication?
auto_failback on #if set to on the resource will automatically fail back 
                  to the primary server once it restores
node server1 #the hostname of the primary server - must match uname -n
node server2 #the hostname of the secondary server</pre>
<p>3.3 Edit the haresources file - it must contain the hostname of the primary server and the floating virtual IP shared by the 2 servers:</p>
<pre>[root@server1 ~]# vim /etc/ha.d/haresources</pre>
<pre>server1 IPaddr::10.0.0.20/255.255.255.0</pre>
<p>Now let's edit the Linux hosts file so that we map each of the hostnames to their corresponind IP address:</p>
<pre>[root@server1 ~]# vim /etc/hosts
 10.0.0.11 server1
 10.0.0.12 server2</pre>
<p>The steps above must be repeated on Server2, please note that the configuration on both the machines in the cluster must match.<br />
After setting up the config on the machines we are ready to start the Heartbeat service.</p>
<p>4. Starting the Heartbeat service:</p>
<pre>[root@server1 ~]# /etc/init.d/heartbeat start
Starting High-Availability services: IPaddr[7248]: INFO: Resource is stopped
Done.</pre>
<p>Now let's test configuration, here comes the tricky part where I encountered some issues with my setup:</p>
<p><a href="http://www.remote-lab.net/wp-content/uploads/2012/02/cluster_setup.png"><img class="aligncenter size-medium wp-image-107" title="cluster_setup" src="http://www.remote-lab.net/wp-content/uploads/2012/02/cluster_setup-300x295.png" alt="" width="300" height="295" /></a></p>
<p>So we've got server1 (10.0.0.11) and server2 (10.0.0.12) running on 2 virtual machine instances. I'm starting some ping packets from my PC (10.0.0.5) to the floating IP address - 10.0.0.20. I'm checking the ARP table of the PC and I'm seeing that 10.0.0.20 is associated to the mac address of server1, the primary node. Next, I shutdown interface eth0 of server1 and as configured in the ha.cf file I'm expecting for the ping packets to fail just for a couple of seconds more than 5 seconds.<br />
Unfortunately I don't get this result with my setup, the ICMP replies start to appear after aproximately 40 seconds.</p>
<p>From what I'm seeing the gratious ARP message which had to be sent by Heartbeat to inform that the HW MAC address corresponding to 10.0.0.20 has changed doesn't reach my PC. So the PC waits until the OS flushes the ARP entry for 10.0.0.20 and then broadcasts another ARP request for 10.0.0.20.</p>
<p>One thing I don't understand is that before sending a broadcast ARP in the network to discover who has 10.0.0.20 my PC sends 3 unicast ARP messages to the MAC Address of the host which went down asking for 10.0.0.20.</p>
<p><a href="http://www.remote-lab.net/wp-content/uploads/2012/02/Screenshot.png"><img class="aligncenter size-large wp-image-108" title="ARP" src="http://www.remote-lab.net/wp-content/uploads/2012/02/Screenshot-1024x110.png" alt="" width="550" height="59" /></a></p>
<p>If you have got any ideas please let me know how I can improve this behavior.</p>

		</div>
	</div>


	
	<div class="related">
		<h4>Related Posts</h2>
		<ul class="posts">
		    
		    <li>
			  <span>05 Apr 2015 &raquo;</span>
			  <a href="http://remoteur.github.io//getting-started-with-docker">Getting started with Docker and the wonders of Open Source</a>
		    </li>
		    
		    <li>
			  <span>24 Feb 2015 &raquo;</span>
			  <a href="http://remoteur.github.io//uncategorized/linux/routing/ios/python/2015/02/24/ospf-lab-provisioning-on-ios-with-ansible/">OSPF lab provisioning on IOS with Ansible</a>
		    </li>
		    
		    <li>
			  <span>12 Oct 2014 &raquo;</span>
			  <a href="http://remoteur.github.io//linux/switching/routing/virtualization/ios/python/2014/10/12/sdn-intro-basic-l2-connectivity-by-using-ovs-and-pox/">SDN Intro: Basic L2 connectivity by using OVS and POX</a>
		    </li>
		    
		</ul>
	</div>
	

	<div class="post-footer">
		<div class="column-1">
			
				<a href="http://remoteur.github.io//routing/2012/01/09/dynamic-routing-with-failover-on-backup-3g-link/"><< Older</a>
			
		</div>
		<div class="column-2"><a href="http://remoteur.github.io// ">Home</a></div>
		<div class="column-3">
			
				<a href="http://remoteur.github.io//uncategorized/2012/02/05/lantronix-ets8p-terminal-server/">Newer >></a>
			
		</div>
	</div>
</div>
 

        <footer class="main-footer">
            <div class="wc-container">
                <div class="column one">
                    <h6>Few more links</h6>
<ul class="menu">
    <li><a href="http://remoteur.github.io//about">About</a></li>
    <li><a href="http://remoteur.github.io//blogroll">Blogroll</a></li>
</ul>		
                    
                </div>
                <div class="column two">
                    <h6>Follow me</h6>

<ul class="social-media">


    
    <li>
        <a title="remoteur on Twitter" 
            href="https://twitter.com/remoteur" 
            class="twitter wc-img-replace" target="_blank">Twitter</a>
    </li>   
    

    
    <li>
        <a title="remoteur on Github" 
            href="https://github.com/remoteur" 
            class="github wc-img-replace" target="_blank">Github</a>
    </li>
     

    
    <li>
        <a title="marius.catalin.31542 on Facebook" 
            href="https://facebook.com/marius.catalin.31542" 
            class="facebook wc-img-replace" target="_blank">Facebook</a>
    </li>
    

    

    

    

</ul>
                </div>
            </div>
            <p class="wc-container disclaimer">
                
Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>
            </p>
        </footer>
        <script type="text/javascript">
          /* To avoid render blocking css */
          var cb = function() {
            var l = document.createElement('link'); l.rel = 'stylesheet';
            l.href = 'http://fonts.googleapis.com/css?family=Ubuntu+Mono&subset=latin';
            var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h);
          };
          var raf = requestAnimationFrame || mozRequestAnimationFrame ||
              webkitRequestAnimationFrame || msRequestAnimationFrame;
          if (raf) raf(cb);
          else window.addEventListener('load', cb);
        </script>
        <!-- jQuery -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- When no internet load JQuery from local -->
        <script>window.jQuery || document.write('<script src="http://remoteur.github.io//assets/js/jquery.min.js"><\/script>')</script>
        <!-- Site js -->
        <script src="http://remoteur.github.io/assets/js/all.js"></script>
        <!-- Google analytics  -->
        
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-xxxx-x']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

    </body>        
</html>
