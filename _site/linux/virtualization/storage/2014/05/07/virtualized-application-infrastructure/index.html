<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Virtualized application infrastructure</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">        
        <meta name="description" content="Harmony is a free responsive jekyll theme by Gayan Virajith and Maheshika Lakmali. Sourced on Github -  https://github.com/gayanvirajith/harmony
">
        <link rel="canonical" 
        href="http://remoteur.github.io//linux/virtualization/storage/2014/05/07/virtualized-application-infrastructure/">
        
        <!-- Harmony styles -->
        <link rel="stylesheet" type="text/css" href="http://remoteur.github.io/assets/css/main.css">

        <!-- Modernizr js -->
        <script async src="http://remoteur.github.io/assets/js/modernizr.js"></script>    

        <!-- IE Fixes -->
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->        
    </head>
    <body class="theme-base-01">
        <header class="main-header">
            <div class="wc-container">
                <h1><a href="http://remoteur.github.io/">remote-lab.net</a></h1>
                <h2>learn by doing</h2>
                <ul>
	<li>
		<a href="http://remoteur.github.io">Home</a><span>/</span>
	</li>
	<li>
		<a href="http://remoteur.github.io//about">About</a><span>/</span>
	</li>
	<li>
		<a href="http://remoteur.github.io//blog">Blog</a><span>/</span>
	</li>
	<li>
		<a href="https://compute.remote-lab.net" target="_blank">Compute</a><span>/</span>
	</li>
</ul>
                
            </div>
        </header>
        <div class="page-content wc-container">
	
	<div class="post">
		<h1>Virtualized application infrastructure</h1>
		<p class="post-meta">
			
      <span class="categories">
      linux, virtualization, and storage
      </span> |
	    
	    <span class="post-date">
    	May 7, 2014 
	    </span>
		</p>		
		<div class="post">
			<p>In this post I'll show how you can build a secure virtualized infrastructure for a basic webapp. We will break the setup into VMs that provide isolated services. You can find below the infrastructure diagram. The followings steps will show how you can set up a bare-metal server running Debian Wheezy to act as a KVM hypervisor and the process of deploying and configuring the VMs and the services they are running. </p>
<p><a href="https://remote-lab.net/wp-content/uploads/2014/05/rlug-New-Page.png"><img src="https://remote-lab.net/wp-content/uploads/2014/05/rlug-New-Page.png" alt="rlug - New Page" width="832" height="814" class="aligncenter size-full wp-image-255" /></a></p>
<p>Install kvm and tools:</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; aptitude install qemu-kvm libvirt-bin virt-manager virt-viewer</code></p>
<p>Install openvswitch :</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; aptitude install openvswitch-switch openvswitch-datapath-source</code></p>
<p>Build Open vSwitch datapath kernel module:</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; module-assistant auto-install openvswitch-datapath</code></p>
<p>The management IP address of the hypervisor and the other public IP addresses are assigned on the same interface by the hosting provider. In order to provide Internet connectivity for the VMs we need to create a bridge containing the physical interface where the public IPs are routed and add the VMs ports to this bridge. The trouble is that since this is also the management link we'll lose connectivity after adding the physical interface to the bridge. After this operation we need to assign the management IP address to the bridge interface. For doing this we edit the /etc/network/interfaces file.</p>
<p>Add openvswitch bridges:</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; ovs-vsctl add-br sw-net</code></p>
<p>Edit the /etc/network/interfaces file:</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; cat /etc/network/interfaces<br />
auto sw-net<br />
iface sw-net inet static<br />
  address   46.4.71.66<br />
  broadcast 46.4.71.95<br />
  netmask   255.255.255.224<br />
  gateway   46.4.71.65<br />
pre-up ip link set dev eth0 up</code></p>
<p>At boot time the openvswitch daemon is started after the network init script so when the network init script is run it won't find the sw-net interface defined in /etc/network/interfaces file. A dirty workaround for this is to re-run the network init script after all the services are loaded. In order to do this we need to edit the /etc/rc.local file:  </p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; cat /etc/rc.local<br />
/etc/init.d/networking restart<br />
exit 0 </code></p>
<p>Now let's add the physical interface to the bridge. After this we should either restart the network service from the console or do a hard reset:</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; ovs-vsctl add-port sw-net eth0</code></p>
<p>The next step is to add the second bridge, where the internal network ports will be connected </p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; ovs-vsctl add-br sw-lan</code></p>
<p>I prefer using virt-install for new VMs provisioning. The problem with it is that it currently doesn't support Open vSwitch bridges so we'll need to adjust it a little by adding the following line to the /usr/lib/pymodules/python2.7/virtinst/VirtualNetworkInterface.py file. This will add the virtualport tag to the VM xml definition:</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; diff -u /usr/lib/pymodules/python2.7/virtinst/VirtualNetworkInterface.py /usr/lib/pymodules/python2.7/virtinst/VirtualNetworkInterface.py.orig<br />
--- /usr/lib/pymodules/python2.7/virtinst/VirtualNetworkInterface.py	2014-05-06 22:06:21.396072330 +0200<br />
+++ /usr/lib/pymodules/python2.7/virtinst/VirtualNetworkInterface.py.orig	2014-05-06 22:13:17.121958858 +0200<br />
@@ -384,7 +384,6 @@<br />
         xml += "      <mac address="%s" />\n" % self.macaddr<br />
         xml += target_xml<br />
         xml += model_xml<br />
-        xml += "      <virtualport type="openvswitch" />\n"<br />
         xml += "    "<br />
         return xml</code></p>
<p>Now that we have the networking ready the last thing that we need are the storage files that the VMs will use. For creating the files we use the qemu-img utility. I prefer qcow2 files as they provide thin provision and snapshot capabilities. /var/lib/libvirt/images is the default directory used by libvirt-bin so let's create the storage files here:</p>
<p><code lang="bash[notools]">root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; qemu-img create -f qcow2 rtr01.qcow2 10G<br />
Formatting 'rtr01.qcow2', fmt=qcow2 size=10737418240 encryption=off cluster_size=65536 </code></p>
<p>We can now create the VM and start the OS installation. We'll first install the rtr01 VM as it will provide Internet connectivity for the rest of the VMs in the internal network. The following command will generate a VM called rtr01 with 4 vCPUs, 4GB of ram, storage file located at /var/lib/libvirt/images/rtr01.qcow2 and 2 network interfaces - one in the bridge connected to the Internet and another connected to the internal network, the console is presented over VNC and it will first boot from the cdrom device loaded from the /var/lib/libvirt/images/vyatta-livecd_VC6.6R1_amd64.iso file. The disk and network interface will use paravirtualized drivers to obtain increased I/O performance.</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; virt-install --name rtr01 --vcpus=4 --ram=4096 --disk path=/var/lib/libvirt/images/rtr01.qcow2,bus=virtio --network bridge=sw-net,model=virtio --network bridge=sw-lan,model=virtio --graphics vnc --cdrom /var/lib/libvirt/images/vyatta-livecd_VC6.6R1_amd64.iso --boot cdrom</code></p>
<p>After this command is issued a console windows will pop up and it will prompt the cdrom installation. After finishing the installation we can proceed to configuring the device:</p>
<p><code lang="bash[notools]"><br />
# set interfaces IP addresses<br />
set interfaces ethernet eth0 mac 00:50:56:00:5e:97<br />
set interfaces ethernet eth0 address 46.4.71.77/27<br />
set protocols static route 0.0.0.0/0 next-hop 46.4.71.65<br />
set system host-name rtr01<br />
set system domain-name nullzero.me<br />
set interfaces ethernet eth1 10.0.1.1/24<br />
set interfaces ethernet eth1 address 10.0.1.1/24
<p># set SNAT for internal network<br />
set nat source rule 10 source address 10.0.1.0/24<br />
set nat source rule 10 outbound-interface eth0<br />
set nat source rule 10 translation address masquerade</p>
<p># set DNAT for the request coming on port tcp 80 on the public IP<br />
set nat destination rule 10 destination address 46.4.71.77<br />
set nat destination rule 10 inbound-interface eth0<br />
set nat destination rule 10 destination port 80<br />
set nat destination rule 10 translation address 10.0.1.2<br />
set nat destination rule 10 translation port 80<br />
set nat destination rule 10 protocol tcp</p>
<p># generate server and client certificates and keys<br />
vyatta@rtr01:~$ sudo -s<br />
vbash-4.1# cp -R /usr/share/doc/openvpn/examples/easy-rsa/2.0/* /etc/openvpn/<br />
edit KEY_COUNTRY, KEY_PROVINCE, KEY_CITY, KEY_ORG, KEY_EMAIL variables<br />
vbash-4.1# vi /etc/openvpn/vars<br />
vbash-4.1# cd /etc/openvpn<br />
vbash-4.1# source vars<br />
vbash-4.1# ./clean-all<br />
vbash-4.1# ./build-ca<br />
vbash-4.1# ./build-dh<br />
vbash-4.1# ./build-key-server rtr01<br />
vbash-4.1# ./build-key client<br />
vbash-4.1# mkdir /config/auth<br />
vbash-4.1# cp -R /etc/openvpn/keys/* /config/auth</p>
<p># configure the server certificates and key location<br />
set interfaces openvpn vtun0 tls ca-cert-file /config/auth/ca.crt<br />
set interfaces openvpn vtun0 tls cert-file /config/auth/rtr01.crt<br />
set interfaces openvpn vtun0 tls dh-file /config/auth/dh1024.pem<br />
set interfaces openvpn vtun0 tls key-file /config/auth/rtr01.key</p>
<p># configure the openvpn server<br />
set interfaces openvpn vtun0 mode server<br />
set interfaces openvpn vtun0 server subnet 172.16.17.0/24<br />
set interfaces openvpn vtun0 server push-route 10.0.1.0/24<br />
set interfaces openvpn vtun0 openvpn-option "--comp-lzo --mssfix --tun-mtu 1488"</p>
<p># openvpn client config file</p>
<p>marius@remoteur:~&gt;&gt;&gt; cat /etc/openvpn/nullzero.conf<br />
client<br />
dev tun<br />
proto udp<br />
remote 46.4.71.77 1194<br />
resolv-retry infinite<br />
nobind<br />
persist-key<br />
persist-tun<br />
ca /etc/openvpn/nullzero/ca.crt<br />
cert /etc/openvpn/nullzero/client.crt<br />
key /etc/openvpn/nullzero/client.key<br />
ns-cert-type server<br />
comp-lzo<br />
verb 3</p>
<p>#configure firewall<br />
set firewall state-policy established action 'accept'<br />
set firewall state-policy related action 'accept'<br />
set firewall all-ping 'enable'<br />
edit firewall name rtr01<br />
set default-action 'drop'<br />
set rule 10 action accept<br />
set rule 10 destination port 22<br />
set rule 10 protocol tcp<br />
set rule 11 action accept<br />
set rule 11 destination port 80<br />
set rule 11 protocol tcp<br />
set rule 12 action accept<br />
set rule 12 destination port 1194<br />
set rule 12 protocol udp<br />
exit<br />
set interfaces ethernet eth0 firewall in name rtr01</p>
<p>After completing these steps we should have a working router, firewall and VPN server.</p>
<p>Now let's continue with creating the second VM. We'll do a network install from minimal CD. First create the storage file:</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; qemu-img create -f qcow2 /var/lib/libvirt/images/lb01.qcow2 10G<br />
Formatting '/var/lib/libvirt/images/lb01.qcow2', fmt=qcow2 size=10737418240 encryption=off cluster_size=65536</code></p>
<p>Next we can start the installation process by using the cdrom file located at /var/lib/libvirt/images/debian-7.5.0-amd64-netinst.iso </p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; virt-install --name lb01 --vcpus=2 --ram=4096 --disk path=/var/lib/libvirt/images/lb01.qcow2,bus=virtio --network bridge=sw-lan,model=virtio  --graphics vnc --cdrom /var/lib/libvirt/images/debian-7.5.0-amd64-netinst.iso --boot cdrom</code></p>
<p>After completing the OS installation we have a fresh running Debian Wheezy system. We don't want to repeat the install process for the other files so we'll just copy the existing image of the Debian system and modify the IP settings and hostnames. We first copy the base image, then attach it by using qemu-nbd, mount the partition where the file system resides and then edit the files that we need.</p>
<p><code lang="bash[notools]">root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; cp lb01.qcow2 db01.qcow2; cp lb01.qcow2 web01.qcow2<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; modprobe nbd max_part=8<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; qemu-nbd -c /dev/nbd0 web01.qcow2<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; kpartx -a /dev/nbd0<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; mount /dev/mapper/nbd0p1 /mnt<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; vim /mnt/etc/network/interfaces<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; vim /mnt/etc/hosts<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; vim /mnt/etc/hostname<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; umount /mnt<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; kpartx -d /dev/nbd0<br />
root@vmm:/var/lib/libvirt/images&gt;&gt;&gt; qemu-nbd -d /dev/nbd0</code></p>
<p>We repeat the steps above for the db01.qcow2 file.</p>
<p>Let's now create the web01 and db01 VMs. Since we already have the base storage files we don't need to run the OS installation:</p>
<p><code lang="bash[notools]">root@vmm:~&gt;&gt;&gt; virt-install --name web01 --vcpus=4 --ram=4096 --disk path=/var/lib/libvirt/images/web01.qcow2,bus=virtio --network bridge=sw-lan,model=virtio  --graphics vnc --import<br />
root@vmm:~&gt;&gt;&gt; virt-install --name db01 --vcpus=4 --ram=4096 --disk path=/var/lib/libvirt/images/db01.qcow2,bus=virtio --network bridge=sw-lan,model=virtio  --graphics vnc --import</code></p>
<p>Once we have booted al the VMs let's start configuring the services.</p>
<p>On the http load balancer we'll install varnish and configure the web server as backend: </p>
<p><code lang="bash[notools]">root@lb01:~&gt;&gt;&gt; aptitude install varnish<br />
root@lb01:~&gt;&gt;&gt; sed -i 's/6081/80/' /etc/default/varnish<br />
root@lb01:~&gt;&gt;&gt; sed -i 's/127.0.0.1/10.0.1.3/' /etc/varnish/default.vcl<br />
root@lb01:~&gt;&gt;&gt; sed -i 's/8080/80/' /etc/varnish/default.vcl<br />
root@lb01:~&gt;&gt;&gt; /etc/init.d/varnish restart</code></p>
<p>On the web server we'll install nginx and php-fpm and configure the default vhost:</p>
<p><code lang="bash[notools]">root@web01:~&gt;&gt;&gt; aptitude install nginx php5-fpm php5-mysql</code></p>
<p>Add the following location block to the first server block:</p>
<p><code lang="bash[notools]">location ~ \.php$ {<br />
        fastcgi_pass   unix:/var/run/php5-fpm.sock;<br />
        fastcgi_index  index.php;<br />
        include        fastcgi_params;<br />
}</code></p>
<p>Create an index file in the document root that will query the database server:</p>
<p><code lang="bash[notools]">root@web01:/srv/www&gt;&gt;&gt; cat index.php<br />
<?php<br />
$con=mysqli_connect("10.0.1.4","user","parola","test");</p>
<p>$result = mysqli_query($con,"SELECT * FROM testable");</p>
<p>$row = mysqli_fetch_array($result);<br />
echo $row['hello'];</p>
<p>mysqli_close($con);<br />
?></code></p>
<p>On the database server we'll install mysql server and create a dummy database and table;</p>
<p><code lang="bash[notools]">root@db01:~&gt;&gt;&gt; aptitude install mysql-server<br />
root@db01:~&gt;&gt;&gt; mysql<br />
Welcome to the MySQL monitor.  Commands end with ; or \g.<br />
Your MySQL connection id is 43<br />
Server version: 5.5.37-0+wheezy1 (Debian)
<p>Copyright (c) 2000, 2014, Oracle and/or its affiliates. All rights reserved.</p>
<p>Oracle is a registered trademark of Oracle Corporation and/or its<br />
affiliates. Other names may be trademarks of their respective<br />
owners.</p>
<p>Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</p>
<p>mysql&gt; create database test;<br />
mysql&gt; use test;<br />
mysql&gt; CREATE TABLE testable (hello VARCHAR(20));<br />
mysql&gt; INSERT INTO testable (hello) VALUES("Hello World!");<br />
mysql&gt; CREATE USER 'user'@'10.0.1.3' IDENTIFIED BY 'parola';<br />
mysql&gt; GRANT ALL PRIVILEGES ON * . * TO 'user'@'10.0.1.3';<br />
mysql&gt; FLUSH PRIVILEGES;<br />
mysql&gt; exit</p>
<p>After this final step we have our setup ready and http://app.nullzero.me/ should show the Hello World!</p>
</code></p></code></p>

		</div>
	</div>


	
	<div class="related">
		<h4>Related Posts</h2>
		<ul class="posts">
		    
		    <li>
			  <span>05 Apr 2015 &raquo;</span>
			  <a href="http://remoteur.github.io//getting-started-with-docker">Getting started with Docker and the wonders of Open Source</a>
		    </li>
		    
		    <li>
			  <span>24 Feb 2015 &raquo;</span>
			  <a href="http://remoteur.github.io//uncategorized/linux/routing/ios/python/2015/02/24/ospf-lab-provisioning-on-ios-with-ansible/">OSPF lab provisioning on IOS with Ansible</a>
		    </li>
		    
		    <li>
			  <span>12 Oct 2014 &raquo;</span>
			  <a href="http://remoteur.github.io//linux/switching/routing/virtualization/ios/python/2014/10/12/sdn-intro-basic-l2-connectivity-by-using-ovs-and-pox/">SDN Intro: Basic L2 connectivity by using OVS and POX</a>
		    </li>
		    
		</ul>
	</div>
	

	<div class="post-footer">
		<div class="column-1">
			
				<a href="http://remoteur.github.io//linux/2014/02/23/junos-interfaces-ip-addresses-a-and-ptr-records-generator/"><< Older</a>
			
		</div>
		<div class="column-2"><a href="http://remoteur.github.io// ">Home</a></div>
		<div class="column-3">
			
				<a href="http://remoteur.github.io//linux/switching/routing/ios/2014/05/21/lab-basic-ospf-routing-scenario/">Newer >></a>
			
		</div>
	</div>
</div>
 

        <footer class="main-footer">
            <div class="wc-container">
                <div class="column one">
                    <h6>Few more links</h6>
<ul class="menu">
    <li><a href="http://remoteur.github.io//about">About</a></li>
    <li><a href="http://remoteur.github.io//blogroll">Blogroll</a></li>
</ul>		
                    
                </div>
                <div class="column two">
                    <h6>Follow me</h6>

<ul class="social-media">


    
    <li>
        <a title="remoteur on Twitter" 
            href="https://twitter.com/remoteur" 
            class="twitter wc-img-replace" target="_blank">Twitter</a>
    </li>   
    

    
    <li>
        <a title="remoteur on Github" 
            href="https://github.com/remoteur" 
            class="github wc-img-replace" target="_blank">Github</a>
    </li>
     

    
    <li>
        <a title="marius.catalin.31542 on Facebook" 
            href="https://facebook.com/marius.catalin.31542" 
            class="facebook wc-img-replace" target="_blank">Facebook</a>
    </li>
    

    

    

    

</ul>
                </div>
            </div>
            <p class="wc-container disclaimer">
                
Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>
            </p>
        </footer>
        <script type="text/javascript">
          /* To avoid render blocking css */
          var cb = function() {
            var l = document.createElement('link'); l.rel = 'stylesheet';
            l.href = 'http://fonts.googleapis.com/css?family=Ubuntu+Mono&subset=latin';
            var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h);
          };
          var raf = requestAnimationFrame || mozRequestAnimationFrame ||
              webkitRequestAnimationFrame || msRequestAnimationFrame;
          if (raf) raf(cb);
          else window.addEventListener('load', cb);
        </script>
        <!-- jQuery -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- When no internet load JQuery from local -->
        <script>window.jQuery || document.write('<script src="http://remoteur.github.io//assets/js/jquery.min.js"><\/script>')</script>
        <!-- Site js -->
        <script src="http://remoteur.github.io/assets/js/all.js"></script>
        <!-- Google analytics  -->
        
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-xxxx-x']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

    </body>        
</html>
