<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Cisco 881G - Configuring Dynamic Failover On a Backup 3G Cellular Link</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">        
        <meta name="description" content="Harmony is a free responsive jekyll theme by Gayan Virajith and Maheshika Lakmali. Sourced on Github -  https://github.com/gayanvirajith/harmony
">
        <link rel="canonical" 
        href="http://remoteur.github.io//routing/2012/01/09/dynamic-routing-with-failover-on-backup-3g-link/">
        
        <!-- Harmony styles -->
        <link rel="stylesheet" type="text/css" href="http://remoteur.github.io/assets/css/main.css">

        <!-- Modernizr js -->
        <script async src="http://remoteur.github.io/assets/js/modernizr.js"></script>    

        <!-- IE Fixes -->
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->        
    </head>
    <body class="theme-base-01">
        <header class="main-header">
            <div class="wc-container">
                <h1><a href="http://remoteur.github.io/">remote-lab.net</a></h1>
                <h2>learn by doing</h2>
                <ul>
	<li>
		<a href="http://remoteur.github.io">Home</a><span>/</span>
	</li>
	<li>
		<a href="http://remoteur.github.io//about">About</a><span>/</span>
	</li>
	<li>
		<a href="http://remoteur.github.io//blog">Blog</a><span>/</span>
	</li>
	<li>
		<a href="https://compute.remote-lab.net" target="_blank">Compute</a><span>/</span>
	</li>
</ul>
                
            </div>
        </header>
        <div class="page-content wc-container">
	
	<div class="post">
		<h1>Cisco 881G - Configuring Dynamic Failover On a Backup 3G Cellular Link</h1>
		<p class="post-meta">
			
      <span class="categories">
      routing
      </span> |
	    
	    <span class="post-date">
    	Jan 9, 2012 
	    </span>
		</p>		
		<div class="post">
			<p>Hello guys,</p>
<p>My latest lab toy is a Cisco 881G which integrates a cellular 3G interface used a secondary data link. In the following article I will present the existing scenario and what needs to be acomplished.</p>
<p><a href="http://www.remote-lab.net/wp-content/uploads/2012/01/3GBackup.png"><img class="aligncenter size-large wp-image-104" title="3GBackup" src="http://www.remote-lab.net/wp-content/uploads/2012/01/3GBackup-1024x748.png" alt="" width="550" height="401" /></a></p>
<p>What's the scenario? We have a small LAN using private IP addresses which need to be translated on both the external links. The primary link is an Ethernet drop so it's very unlikely to change its state to down so that the router can detect the link failure and make the changes in its RIB. In order to detect a failure on the primary link we have to implement a mechanism which takes an external point as reference and measures different parameters.  For instance in my scenario we will send ICMP packets to an external IP address - 8.8.8.8, the Google public DNS server, and measure the RTT. As long as the RTT value is within certain limits the default route will be set on the primary link.<br />
If it exceeds that value then the default route set on the primary link will be dropped out of the routing table and a secondary default route - the one from the backup link, which has a higher administrative distance will take its place.</p>
<p>We have to make sure that the ICMP packets sent for checking the RTT will be sent only from the primary link. Otherwise when the backup link becomes active it checks the RTT and gets a proper value and it install the primary default route thus resulting in a loop of default routes.</p>
<p>Enough with the words, now let's get to the config lines:</p>
<p>First of all, let's configure the cellular interface so that it can connect to the 3G network:</p>
<h5>Configuring the cellular interface</h5>
<p>We must ensure that the SIM card is not locked with a PIN code - Cellular 0 is the interface:</p>
<pre>Router#cellular 0 gsm sim unlock <em>PIN</em></pre>
<p><em></em>   We need to create a gsm profile with the settings associated with your data account:</p>
<pre>Router#cellular 0 gsm profile create 1 internet ipv4 pap cisco cisco</pre>
<p>"1" - Profile number<br />
"internet" - Access Point Name<br />
"ipv4" - Packet Data Protocol<br />
"pap" - Authentication type<br />
"cisco" - Username<br />
"cisco" - Password</p>
<p>Next we need to create a chat script which sends commands to the 3G modem to connect to the remote system. The chat script is called CellScript with a timeout value of 30 seconds. Please note that the script may be different depending on the carrier.</p>
<pre>Router(config)#chat-script CellScript "" "ATDT*98*<strong>1</strong>#" TIMEOUT 30 "CONNECT"</pre>
<p>"1" - represents the number of the gsm profile created above</p>
<p>Associate the created chat script to the 3G modem line, for the 881G is line 3:</p>
<pre>Router(config)#line 3
Router(config-line)#script dialer CellScript</pre>
<p>Next we should create a Dialer interface:</p>
<pre>Router(config)#interface Dialer2
Router(config-if)#ip address negotiated
Router(config-if)#ip virtual-reassembly in
Router(config-if)#encapsulation ppp
Router(config-if)#dialer pool 2
Router(config-if)#dialer idle-timeout 0
Router(config-if)#dialer string CellScript
Router(config-if)#dialer persistent
Router(config-if)#dialer-group 2
Router(config-if)#ppp authentication pap callin
Router(config-if)#ppp pap password 7 045F1E0B0238
Router(config-if)#ppp ipcp dns request
Router(config-if)#no cdp enable</pre>
<p>The next step required is to configure the Cellular interface</p>
<pre>Router(config)#interface Cellular0
Router(config-if)#ip address negotiated
Router(config-if)#ip virtual-reassembly in
Router(config-if)#encapsulation ppp
Router(config-if)#dialer in-band
Router(config-if)#dialer pool-member 2
Router(config-if)#dialer idle-timeout 0
Router(config-if)#dialer-group 2
Router(config-if)#async mode interactive</pre>
<p>Create a dialer list which allows IP packets for the interfaces in dialer group 2:</p>
<pre> Router(config)#dialer-list 2 protocol ip permit</pre>
<p>Add a default route and you should have a working 3G data link:</p>
<pre>Router(config)#ip route 0.0.0.0 0.0.0.0 Dialer2</pre>
<h5> Configuring NAT with multiple pools</h5>
<p>OK, now that we have set the 3G backup data link I presume that you know how to configure the primary Ethernet link so we can pass to the next section: how to get Network Address Translation work on both interfaces.</p>
<p>First we need to set an access list which identifies our private addresses - in my case: 10.0.0.0/28</p>
<pre>Router(config)#access-list 10 permit 10.0.0.0 0.0.0.15</pre>
<p>Next we'll create route maps which identify both the private ip addresses by the ACL created above and the external interface:</p>
<pre>Router(config)#route-map PRIMARY permit 1 -&gt; 1 is a sequence number in the route map function
Router(config-route-map) #match ip address 10 -&gt; matches all IP traffic identified by ACL 10
Router(config-route-map)#match interface FastEthernet4</pre>
<pre>Router(config)#route-map BACKUP permit 1
Router(config-route-map) #match ip address 10
Router(config-route-map)#match interface Dialer2</pre>
<p>Last we have to set the NAT direction on the interfaces we are interested in:</p>
<pre>Router(config)#interface Vlan 55
Router(config-if)#ip nat inside</pre>
<pre>Router(config)#interface FastEthernet4
Router(config-if)#ip nat outside</pre>
<pre>Router(config)#interface Dialer2
Router(config-if)#ip nat outside</pre>
<p>Now that we have the route maps set we need the create the NAT translation rules. On both of the interfaces I will set NAT overload as I have a single IP address assigned by the ISP:</p>
<pre>Router(config)# ip nat inside source route-map PRIMARY interface FastEthernet4 overload
Router(config)# ip nat inside source route-map BACKUP interface Dialer2 overload</pre>
<h5>Configuring dynamic failover with Cisco IP SLAs</h5>
<p>The address translation is complete too. In the next section we will implement the dynamic failover mechanism using Cisco IP Service Level Agreements ( SLAs ). The Cisco IOS IP SLA is a powerful tool which can help improve your networks services. It allows you to monitor traffic parameters like round-trip delay, one-way delay, one-way jitter, packet loss, TCP connection time, DNS lookup time and many others. Let's get to the config line and show how we should implement the SLAs.</p>
<pre>Router(config)#ip sla 1
Router(config)#icmp-echo 8.8.8.8 interface FastEthernet 4 -&gt; pings 8.8.8.8 with the source address of Fa4
Router(config)#timeout 150 -&gt; the amount of time in milliseconds the IP SLA operation waits a response from its request packet
Router(config)#frequency  2 -&gt; the amount of time in seconds at which the IP SLA operation performs
Router(config)#ip sla schedule 1 life forever start-time now</pre>
<p>To review the above config lines: The routers pings 8.8.8.8 with  ICMP REQUEST packets having the source address of Fa4 and if an ICMP REPLY packet isn't received within 150ms the IP SLA operation is considered to have failed. This process is repeated once every 2 seconds.<br />
We set this process to start now and occur forever.</p>
<p>Now what happens if the IP SLA operation fails? In the following lines we'll tell the router what to do in that case:</p>
<p>We need to create a track object to monitor the status of the IP SLA we have created:</p>
<pre>Router(config)#track 1 ip sla 1 reachability</pre>
<p>The track object informs the static route if a state change of the IP SLA occurs.</p>
<p>Next we will associate the primary default route with the tracker.</p>
<pre>Router(config)#ip route 0.0.0.0 0.0.0.0 FastEthernet4 track 1</pre>
<p>and assign a higher administrative distance to the secondary default route:</p>
<pre>Router(config)#ip route 0.0.0.0 0.0.0.0 Dialer2 10</pre>
<p>And that should be all. You should now have a dynamic failover route without having to enable dynamic routing protocols.</p>
<p>Pretty cool :)</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

		</div>
	</div>


	
	<div class="related">
		<h4>Related Posts</h2>
		<ul class="posts">
		    
		    <li>
			  <span>05 Apr 2015 &raquo;</span>
			  <a href="http://remoteur.github.io//getting-started-with-docker">Getting started with Docker and the wonders of Open Source</a>
		    </li>
		    
		    <li>
			  <span>24 Feb 2015 &raquo;</span>
			  <a href="http://remoteur.github.io//opsf-on-ios-with-ansible">OSPF lab provisioning on IOS with Ansible</a>
		    </li>
		    
		    <li>
			  <span>12 Oct 2014 &raquo;</span>
			  <a href="http://remoteur.github.io//linux/switching/routing/virtualization/ios/python/2014/10/12/sdn-intro-basic-l2-connectivity-by-using-ovs-and-pox/">SDN Intro: Basic L2 connectivity by using OVS and POX</a>
		    </li>
		    
		</ul>
	</div>
	

	<div class="post-footer">
		<div class="column-1">
			
				<a href="http://remoteur.github.io//linux/2011/11/22/virtualbox-web-interface/"><< Older</a>
			
		</div>
		<div class="column-2"><a href="http://remoteur.github.io// ">Home</a></div>
		<div class="column-3">
			
				<a href="http://remoteur.github.io//linux/2012/01/15/linux-server-cluster-using-heartbeat/">Newer >></a>
			
		</div>
	</div>
</div>
 

        <footer class="main-footer">
            <div class="wc-container">
                <div class="column one">
                    <h6>Few more links</h6>
<ul class="menu">
    <li><a href="http://remoteur.github.io//about">About</a></li>
    <li><a href="http://remoteur.github.io//blogroll">Blogroll</a></li>
</ul>		
                    
                </div>
                <div class="column two">
                    <h6>Follow me</h6>

<ul class="social-media">


    
    <li>
        <a title="remoteur on Twitter" 
            href="https://twitter.com/remoteur" 
            class="twitter wc-img-replace" target="_blank">Twitter</a>
    </li>   
    

    
    <li>
        <a title="remoteur on Github" 
            href="https://github.com/remoteur" 
            class="github wc-img-replace" target="_blank">Github</a>
    </li>
     

    
    <li>
        <a title="marius.catalin.31542 on Facebook" 
            href="https://facebook.com/marius.catalin.31542" 
            class="facebook wc-img-replace" target="_blank">Facebook</a>
    </li>
    

    

    

    

</ul>
                </div>
            </div>
            <p class="wc-container disclaimer">
                
Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>
            </p>
        </footer>
        <script type="text/javascript">
          /* To avoid render blocking css */
          var cb = function() {
            var l = document.createElement('link'); l.rel = 'stylesheet';
            l.href = 'http://fonts.googleapis.com/css?family=Ubuntu+Mono&subset=latin';
            var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h);
          };
          var raf = requestAnimationFrame || mozRequestAnimationFrame ||
              webkitRequestAnimationFrame || msRequestAnimationFrame;
          if (raf) raf(cb);
          else window.addEventListener('load', cb);
        </script>
        <!-- jQuery -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- When no internet load JQuery from local -->
        <script>window.jQuery || document.write('<script src="http://remoteur.github.io//assets/js/jquery.min.js"><\/script>')</script>
        <!-- Site js -->
        <script src="http://remoteur.github.io/assets/js/all.js"></script>
        <!-- Google analytics  -->
        
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-xxxx-x']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

    </body>        
</html>
